# ソケット通信の基本

ソケットとは、ネットワーク通信に利用するファイルの一種です。
ソケットに紐付けられた「ファイルディスクリプタ」を用いてアプリケーションに対してデータを送ることができる。

ファイルディスクリプタとは、標準入出力やファイル入出力をOSが識別するための`識別子`であり、0は標準入力、1は標準出力、2は標準エラー出力と決められている。
ファイルへの入出力やソケット通信で用いる入出力には3以上の整数が用いられる。

# 通信の流れ

ソケット通信は一般的にサーバとクライアント間で通信を行う。

## サーバサイドのフロー

-1. socket()はソケット（ファイルディスクリプタ）を作成する。
-2. bind()はソケットをローカルのアドレス（ソケットファイルやIP+ポート）にバインドする。
-3. listen()はソケットに接続を待ち受けるように命令します。
-4. accept()は外部からの接続に対して新しいソケットを作成します。
-5. send()はデータの送信を行う
-6. receive()はデータの受信を行う
-7. close()ではソケットをクローズし、ファイルディスクリプタも削除する。

`5`と`6`は繰り返す。

## クライアントサイドのフロー

-1. socket()はソケット（ファイルディスクリプタ）を作成する。
-2. connect()はリモートのソケットに接続する。
-3. send()はデータの送信を行う
-4. receive()はデータの受信を行う
-5. close()ではソケットをクローズし、ファイルディスクリプタも削除する。

# ソケット通信のバリエーション
ソケット通信はいくつもの方式があり、方式を決めるためのキーとなるパラメータは大きく以下の2つがある。

- アドレスファミリー
- ソケットタイプ

## アドレスファミリー

アドレスタイプは作成したソケットにバインドするアドレスの種類を表す。
以下に主要なアドレスファミリーとその概要を示します。

例えば、`IPv4`を使用した通信であれば`AF_INET`、IPv6を使用した通信であれば`AF_INET6`を利用する。

このようにアドレスファミリーでは、`ソケット（ファイルディスクリプタ）`に`ソケットファイル`や`IPアドレス＋ポート番号`を紐づける。


| アドレスファミリー | 説明 | 指定するアドレス |
| ---- | ---- | ---- |
| AF_UNIX | ローカル通信に使用する。同一マシン上で効率的なプロセス間通信を可能とする。Unixドメインソケット通信。 | ソケットファイルのファイルパス |
| AF_INET | IPv4 インターネットプロトコル。TCPソケット通信。 | ホスト名、ポート番号 |
| AF_INET6 | IPv6 インターネットプロトコル。TCPソケット通信。 | ホスト名、ポート番号 |

## ソケットタイプ

TCP通信を行うのであれば`SOCK_STREAM`、UDP通信を行うのであれば`SOCK_DGRAM`を使用する。

| タイプ | 説明 |
| ---- | ---- |
| SOCK_STREAM | 順序性と信頼性がある双方向のバイトストリーム。TCPソケット通信で利用されるタイプ。 |
| SOCK_DGRAM | データグラム（コネクションレスで信頼性が無く、最大サイズが固定）をサポート。UDPソケット通信で利用される。 |

`SOCK_SEQPACKET`や`SOCK_RAW`など上記以外にも複数のソケットタイプがある。

[socket linux manual page](https://man7.org/linux/man-pages/man2/socket.2.html)

# 動作チェック

```bash
$ python server_side.py
Server [started] : ('127.0.0.1', 8890)
[message_resp] response: (aaaa)
[message_resp] response: (bbb)
[message_resp] response: ()
[message_resp] response: ()
```

```bash
$ python client_side.py
> aaaa
response: (aaaa)
> bbb
response: (bbb)
> .quit
```

## HTTP Request Check

TCPソケット通信のサーバに対して`curl`コマンドで`HTTPのPOSTリクエスト`を投げてみる。

以下を行ってみると、実際にサーバ側ではPOSTリクエストを正常に受信できていることが確認できる。

この結果からHTTPの通信はTCPソケット通信を用いた単なるテキストデータの交換であることがわかる。

```bash
$ python server_side.py
Server [started] : ('127.0.0.1', 8890)
[message_resp] response: (POST / HTTP/1.1
Host: localhost:8890
User-Agent: curl/7.87.0
Accept: */*
Content-Length: 7
Content-Type: application/x-www-form-urlencoded
```

```bash
$ curl -d "hogehge" localhost:8890
```
